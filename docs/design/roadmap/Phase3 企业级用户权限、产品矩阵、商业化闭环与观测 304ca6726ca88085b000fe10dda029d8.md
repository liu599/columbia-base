# Phase3: 企业级用户权限、产品矩阵、商业化闭环与观测

**阶段目标：** 系统从“能用”走向“好用且能赚钱”。建立严密的账户隔离机制、精细化的账本与计量计费系统，同时补齐全链路监控，支撑正式商业化运营。

**各个语言/组件开发清单：**

- **前端层 (React 19 / Next.js)：**
    - 注册/登录/密码找回页面及第三方授权逻辑。
    - Pricing 套餐定价页及充值收银台界面。
    - 个人中心：展示 Token 额度余量、会员有效期及账单流水。
- **业务服务层 (Java / Spring Boot + MyBatis Plus)：**
    - **用户与账户服务：** 引入 JWT，配合 MyBatis Plus 构建完整的 `UserAccount`, `UserProfile` 注册登录体系及拦截器（Interceptor）。
    - **商业权益服务：** 实现订单表 (`Order`) 的状态机推进，对接外部支付平台 Webhook 回调。
    - **额度账本服务 (QuotaLedger)：** 构建严密的额度扣减服务，确保并发提问时高精度的 Token 扣费，防止超卖。
- **智能与基础服务层 (Python / FastAPI)：**
    - **多租户隔离约束：** 在 RAG 的混合检索查询 DSL 中，强制注入 `user_id` 和 `tenant_id` 过滤条件，做到数据物理隔离。
    - **Token 结算上报：** 每次 Agent 循环结束后，精准计算 Prompt 及 Completion 的 Token 消耗，通过 gRPC 或 MQ 上报 Java 账单中心。
- **基建中间件配置：**
    - **网关接入层 (Nginx/APISIX)：** 配置全局 Token 鉴权插件。
    - **观测中台：** 部署 Prometheus (指标收集) + Grafana (大盘监控) + SkyWalking (全链路追踪)，打通从 Nginx 到 Python 的 `X-Trace-Id`。
    - **MySQL：** 落地商业化相关的核心领域模型（用户库、订单库、额度流水账本）。

> **🏆 Phase 3 交付标准 (Definition of Done):**
> 
> - ✅ 新用户能顺畅完成注册入驻，获得初始体验额度。
> - ✅ 知识库数据实现严格隔离，用户 A 绝对搜不到用户 B 的私有文档。
> - ✅ 用户发起提问后，系统能根据真实 Token 消耗，在 MyBatis Plus 驱动的账户表中精准扣费；余额不足时，前端能优雅熔断并弹窗引导充值。
> - ✅ 运维人员可通过任意一次问答的 Trace ID，在监控大盘完整查看该请求在 Java、Redis、Python 的完整耗时瀑布图。